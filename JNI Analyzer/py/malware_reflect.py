import os
import subprocess


def get_file(base, extension):
    list = []
    for root, ds, fs in os.walk(base):
        for f in fs:
            if f.endswith(extension):
                fullname = os.path.join(root, f)
                list.append(fullname)
    return list

def call(args, timeout):
    p = subprocess.Popen(args, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    try:
        out, err = p.communicate(timeout=timeout)
        print(out)
    except subprocess.TimeoutExpired:
        print('*** time out ***', timeout, 's')
        p.kill()
        out, err = p.communicate()
        print(out)

# base = '/mal/APK/malware16171819'
base = '/mal/APK/google_benign'
files = get_file(base, '.apk')
if(len(files)>10000):
    files = files[:10000]
# print(files)
total = len(files)
for i, apk in enumerate(files):
    if i<2698:
        continue
    # if not os.path.exists('log/%i_%i' % (i, total)):
    #     os.mkdir('log/%i_%i' % (i, total))
    print(i, '/', total)
    cmd = 'java -jar apkreflect.jar -android-jars android-platforms-master -process-dir %s -process-multiple-dex' % apk
    print(cmd)
    cmd_args = cmd.split(' ')
    print(cmd_args)
    # os.system(cmd)
    # call(['ping', 'www.baidu.com'], 10)
    # 5 mins
    timeout = 60 * 5
    call(cmd_args, timeout)
    # exit(1)
